```{r _outliers_setup_script}
source("../_setup.R")
```

# Outliers

This section examines flagged, non-arms-length sales, hereafter called "outliers". These sales are identified via a [dedicated sales validation model](https://github.com/ccao-data/model-sales-val). Note that unless otherwise specified, all figures and tables include data from _all triads_.

## Counts and Percentages

::: panel-tabset

As of 12/6/2024, we have three columns that represent distinct outlier reasons.

Sales are considered outliers only if they meet specific price-related
criteria. Namely, if their price falls a certain number of standard deviations
away from the average price within a comparable property group. We will focus
exclusively on these price-based factors that determine outlier status.

### Count by Type

```{r _outliers_type_breakdown}
training_data_outlier_analysis <-
  training_data %>%
  mutate(
    sv_outlier_reason_simplified = case_when(
      # Check for combined algorithm / analyst determinations
      # Review Non arms length + algorithm price
      str_detect(
        sv_outlier_reason,
        regex("Review:\\s*Non-Arms-Length", ignore_case = TRUE)
      ) &
        str_detect(
          sv_outlier_reason,
          regex(
            "Algorithm:\\s*Low price(\\s*per\\s*square\\s*foot)?",
            ignore_case = TRUE
          )
        ) ~
        "Review: Non-Arms-Length, Algorithm: Low price",
      str_detect(
        sv_outlier_reason,
        regex("Review:\\s*Non-Arms-Length", ignore_case = TRUE)
      ) &
        str_detect(
          sv_outlier_reason,
          regex(
            "Algorithm:\\s*High price(\\s*per\\s*square\\s*foot)?",
            ignore_case = TRUE
          )
        ) ~
        "Review: Non-Arms-Length, Algorithm: High price",
      # Review flip + algorithm price
      str_detect(
        sv_outlier_reason, regex("Review:\\s*Flip", ignore_case = TRUE)
      ) &
        str_detect(
          sv_outlier_reason,
          regex(
            "Algorithm:\\s*Low price(\\s*per\\s*square\\s*foot)?",
            ignore_case = TRUE
          )
        ) ~
        "Review: Flip, Algorithm: Low price",
      str_detect(
        sv_outlier_reason, regex("Review:\\s*Flip", ignore_case = TRUE)
      ) &
        str_detect(
          sv_outlier_reason,
          regex(
            "Algorithm:\\s*High price(\\s*per\\s*square\\s*foot)?",
            ignore_case = TRUE
          )
        ) ~
        "Review: Flip, Algorithm: High price",
      # Reasons that are algorithm only or review only
      str_detect(sv_outlier_reason, regex("High price", ignore_case = TRUE)) &
        str_detect(
          sv_outlier_reason, regex("PTAX-203 Exclusion", ignore_case = TRUE)
        ) ~
        "Algorithm: Outlier, High price, PTAX-flag",
      str_detect(sv_outlier_reason, regex("Low price", ignore_case = TRUE)) &
        str_detect(
          sv_outlier_reason, regex("PTAX-203 Exclusion", ignore_case = TRUE)
        ) ~
        "Algorithm: Outlier, Low price, PTAX-flag",
      str_detect(sv_outlier_reason, regex("High price", ignore_case = TRUE)) ~
        "Algorithm: Outlier, High price",
      str_detect(sv_outlier_reason, regex("Low price", ignore_case = TRUE)) ~
        "Algorithm: Outlier, Low price",
      TRUE ~ sv_outlier_reason
    )
  ) %>%
  # This data isn't used in the training data and as such we remove it for
  # further analysis
  filter(!ind_pin_is_multicard)

# Determine the axis limit
y_lim_axis_outlier_breakdown <- training_data_outlier_analysis %>%
  filter(sv_is_outlier) %>%
  count(sv_outlier_reason_simplified) %>%
  summarise(max_value = max(n)) %>%
  pull(max_value)

training_data_outlier_analysis %>%
  filter(sv_is_outlier) %>%
  count(sv_outlier_reason_simplified) %>%
  ggplot(aes(x = reorder(sv_outlier_reason_simplified, -n), y = n)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = comma(n)), vjust = -0.5) +
  ylim(0, 1.05 * y_lim_axis_outlier_breakdown) +
  labs(y = "Number of Sales", x = "Outlier Reasons") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 70, hjust = 1),
    axis.text.y = element_text(angle = 45, hjust = 1),
    axis.title.y = element_blank(),
    axis.title.x = element_blank()
  )
```



### Count by Type and Year

```{r _outliers_type_breakdown_table}
outlier_by_year_type <- training_data_outlier_analysis %>%
  filter(sv_is_outlier) %>%
  count(meta_year, sv_outlier_reason_simplified, name = "n") %>%
  rename(Year = meta_year) %>%
  pivot_wider(
    id_cols = Year,
    names_from = sv_outlier_reason_simplified,
    values_from = n,
    values_fill = 0
  )

total_sales_by_year <- training_data_outlier_analysis %>%
  count(meta_year, name = "total_sales") %>%
  rename(Year = meta_year)

outlier_by_year_type %>%
  left_join(total_sales_by_year, by = "Year") %>%
  mutate(
    `Total outliers` = rowSums(
      across(where(is.numeric) & !any_of("total_sales"))
    ),
    `Outlier %` = `Total outliers` / total_sales
  ) %>%
  select(Year, `Total outliers`, `Outlier %`, everything(), -total_sales) %>%
  mutate(
    `Total outliers` = scales::comma(`Total outliers`),
    `Outlier %` = scales::percent(`Outlier %`, accuracy = 0.1)
  ) %>%
  kable() %>%
  kable_styling("striped") %>%
  column_spec(2, bold = TRUE) %>% # Total outliers
  column_spec(3, bold = TRUE, color = "#084B99")
```

### Percentage by Class

```{r _outliers_pct_class}
training_data_outlier_analysis %>%
  summarise(
    percent = mean(case_when(sv_is_outlier ~ 1, TRUE ~ 0)),
    .by = meta_class
  ) %>%
  filter(!meta_class %in% c("218", "219")) %>%
  ggplot(aes(x = meta_class, y = percent)) +
  geom_bar(stat = "identity") +
  geom_text(
    mapping = aes(label = scales::percent(percent, accuracy = .1)),
    hjust = -0.1,
    angle = 90
  ) +
  theme_minimal() +
  scale_y_continuous(
    labels = scales::percent_format(),
    expand = expansion(add = c(0, 0.02))
  ) +
  theme(
    axis.title.y = element_blank(),
    axis.title.x = element_blank()
  )
```

### Percentage by Township

```{r _outliers_pct_township}
y_lim_axis_outlier_townships <- training_data_outlier_analysis %>%
  group_by(meta_township_name) %>%
  summarise(percent = mean(case_when(sv_is_outlier == TRUE ~ 1, TRUE ~ 0))) %>%
  ungroup() %>%
  slice_max(percent, n = 1) %>%
  pull(percent)

training_data_outlier_analysis %>%
  summarise(
    percent = mean(case_when(sv_is_outlier ~ 1, TRUE ~ 0)),
    .by = c(meta_township_name, meta_triad_name)
  ) %>%
  ggplot(aes(x = reorder(meta_township_name, -percent), y = percent)) +
  geom_bar(stat = "identity") +
  geom_text(
    mapping = aes(label = scales::percent(percent, accuracy = .1)),
    hjust = -0.1,
    angle = 90,
    size = 2.5
  ) +
  theme_minimal() +
  scale_y_continuous(
    labels = scales::percent_format(),
    limits = c(0, 1.15 * y_lim_axis_outlier_townships)
  ) +
  theme(
    axis.text.x = element_text(angle = 60, hjust = 1),
    axis.title.y = element_blank(),
    axis.title.x = element_blank(),
  ) +
  facet_wrap(vars(meta_triad_name), scales = "free_x")
```

:::

## Distributions

::: panel-tabset

### By Outlier Status

```{r _outliers_dist_price}
training_data_outlier_analysis %>%
  summarise(
    Min = min(meta_sale_price),
    Median = median(meta_sale_price),
    Mean = mean(meta_sale_price),
    Max = max(meta_sale_price),
    `Std. Dev.` = sd(meta_sale_price),
    .by = sv_is_outlier
  ) %>%
  mutate(Category = ifelse(sv_is_outlier, "Outlier", "Not Outlier")) %>%
  relocate(Category, .before = NULL) %>%
  select(-sv_is_outlier) %>%
  mutate(across(Min:`Std. Dev.`, dollar)) %>%
  kable() %>%
  kable_styling(full_width = TRUE)

training_data_outlier_analysis %>%
  mutate(
    Category = ifelse(sv_is_outlier, "Outlier", "Not Outlier"),
    Category = factor(Category, levels = c("Outlier", "Not Outlier"))
  ) %>%
  filter(meta_sale_price < 1.5e7) %>%
  ggplot(aes(meta_sale_price, fill = Category)) +
  geom_density(alpha = 0.5) +
  theme_minimal() +
  labs(x = "Log Sale Price") +
  scale_y_continuous(labels = scales::percent_format()) +
  scale_x_log10(labels = scales::dollar_format()) +
  theme(
    legend.position = "bottom",
    legend.title = element_blank(),
    axis.title.y = element_blank(),
    axis.ticks.y = element_blank()
  )
```

### By Price Per Square Foot

```{r _outliers_dist_price_per_sqft}
outliers_dist_price_per_sqft <- training_data_outlier_analysis %>%
  filter(!is.na(char_bldg_sf) & char_bldg_sf > 0) %>%
  mutate(ppsf = meta_sale_price / char_bldg_sf)
outliers_dist_price_per_sqft %>%
  summarise(
    Min = min(ppsf),
    Median = median(ppsf),
    Mean = mean(ppsf),
    Max = max(ppsf),
    `Std. Dev` = sd(ppsf),
    .by = sv_is_outlier
  ) %>%
  mutate(Category = ifelse(sv_is_outlier, "Outlier", "Not outlier")) %>%
  relocate(Category, .before = NULL) %>%
  select(-sv_is_outlier) %>%
  mutate(across(Min:`Std. Dev`, dollar)) %>%
  kable() %>%
  kable_styling(full_width = TRUE)
outliers_dist_price_per_sqft %>%
  mutate(
    Category = ifelse(sv_is_outlier, "Outlier", "Not Outlier"),
    Category = factor(Category, levels = c("Outlier", "Not Outlier"))
  ) %>%
  filter(meta_sale_price < 2.5e6) %>%
  ggplot(aes(ppsf, fill = Category)) +
  geom_density(alpha = 0.5) +
  labs(title = "Cumulative Distribution") +
  theme_minimal() +
  labs(x = "Log Price Per Square Foot") +
  scale_y_continuous(labels = scales::percent_format()) +
  scale_x_log10(labels = scales::dollar_format()) +
  theme(
    legend.position = "bottom",
    legend.title = element_blank(),
    axis.title.y = element_blank(),
    axis.ticks.y = element_blank()
  )
```

### By Township

```{r _outliers_dist_township, fig.height=8, fig.width=7}
training_data_outlier_analysis %>%
  filter(meta_triad_name == run_triad) %>%
  mutate(
    township_name = ccao::town_convert(meta_township_code),
    Category = ifelse(sv_is_outlier, "Outlier", "Not Outlier"),
    Category = factor(Category, levels = c("Outlier", "Not Outlier"))
  ) %>%
  filter(meta_sale_price < 2.5e6) %>%
  ggplot(aes(meta_sale_price, fill = Category)) +
  geom_density(alpha = 0.5) +
  theme_minimal() +
  labs(x = "Log Sale Price") +
  scale_y_continuous(labels = scales::percent_format()) +
  scale_x_log10(labels = scales::dollar_format()) +
  theme(
    legend.position = "bottom",
    legend.title = element_blank(),
    axis.text.x = element_text(angle = 45, hjust = 1),
    axis.title.y = element_blank(),
    axis.ticks.y = element_blank()
  ) +
  facet_wrap(vars(township_name), ncol = 3)
```

### By Class

```{r _outliers_dist_class, fig.height=8, fig.width=7}
training_data_outlier_analysis %>%
  filter(
    meta_triad_name == run_triad,
    !meta_class %in% c("218", "219")
  ) %>%
  mutate(
    township_name = ccao::town_convert(meta_township_code),
    Category = ifelse(sv_is_outlier, "Outlier", "Not Outlier"),
    Category = factor(Category, levels = c("Outlier", "Not Outlier"))
  ) %>%
  filter(meta_sale_price < 5e6) %>%
  ggplot(aes(meta_sale_price, fill = Category)) +
  geom_density(alpha = 0.5) +
  theme_minimal() +
  labs(x = "Log Sale Price") +
  scale_y_continuous(labels = scales::percent_format()) +
  scale_x_log10(labels = scales::dollar_format()) +
  theme(
    legend.position = "bottom",
    legend.title = element_blank(),
    axis.text.x = element_text(angle = 45, hjust = 1),
    axis.title.y = element_blank(),
    axis.ticks.y = element_blank()
  ) +
  facet_wrap(vars(meta_class), ncol = 3)
```

### Ratio Comparison

```{r _outliers_ratio_comparison, fig.height=8, fig.width=7}
outliers_ratio_comparison <- training_data_outlier_analysis %>%
  summarise(
    median_sale_price = median(meta_sale_price),
    .by = c(sv_is_outlier, meta_township_name)
  ) %>%
  arrange(meta_township_name, sv_is_outlier) %>%
  group_by(meta_township_name) %>%
  mutate(
    percent = last(median_sale_price) / first(median_sale_price),
    above_below = ifelse(percent > 1,
      "Outlier > Not Outlier", "Not Outlier > Outlier"
    ),
    above_below = factor(above_below,
      levels =
        c("Outlier > Not Outlier", "Not Outlier > Outlier")
    ),
    triad = ccao::town_get_triad(meta_township_name, name = TRUE)
  ) %>%
  distinct(meta_township_name, percent, above_below, triad)

outliers_ratio_comparison %>%
  ggplot(aes(x = reorder(meta_township_name, percent), y = percent)) +
  labs(
    fill = "Median Price"
  ) +
  geom_bar(stat = "identity", aes(fill = above_below)) +
  coord_flip() +
  geom_text(aes(label = round(percent, 2)), size = 3.2, hjust = -0.2) +
  scale_y_continuous(limits = c(0, 2.4)) +
  theme_minimal() +
  theme(
    axis.title.y = element_blank(),
    axis.title.x = element_blank(),
    panel.grid.major.y = element_blank()
  ) +
  facet_wrap(vars(triad), ncol = 1, scales = "free_y", strip.position = "right")
```

:::

## Visualized on a map

```{r _outlier_proportion_by_nbhd_on_map}
nbhd_sf <- ccao::nbhd_shp %>%
  st_as_sf() %>%
  st_transform(4326) %>%
  mutate(nbhd_code = as.character(nbhd))

township_sf <- ccao::town_shp %>%
  st_as_sf() %>%
  st_transform(4326)

reason_breakdown <- training_data_outlier_analysis %>%
  filter(!is.na(meta_triad_name), !is.na(meta_nbhd_code)) %>%
  group_by(meta_triad_name, meta_nbhd_code, sv_outlier_reason_simplified) %>%
  summarise(n_reason = n(), .groups = "drop") %>%
  group_by(meta_triad_name, meta_nbhd_code) %>%
  mutate(
    pct_of_total = n_reason / sum(n_reason),
  ) %>%
  arrange(desc(n_reason), .by_group = TRUE) %>%
  summarise(
    reason_html = paste0(
      "<ul style='margin:0; padding-left: 18px;'>",
      paste0(
        "<li>",
        htmlEscape(sv_outlier_reason_simplified),
        ": <strong>", n_reason, "</strong> (", sprintf("%.1f%%", pct_of_total * 100), ")", # nolint
        "</li>",
        collapse = ""
      ),
      "</ul>"
    ),
    .groups = "drop"
  )

nbhd_summary <- training_data_outlier_analysis %>%
  mutate(
    meta_nbhd_code = as.character(meta_nbhd_code),
    meta_triad_name = as.character(meta_triad_name)
  ) %>%
  group_by(meta_triad_name, meta_nbhd_code) %>%
  summarise(
    total_sales = n(),
    outlier_prop = mean(sv_is_outlier, na.rm = TRUE),
    outlier_count = sum(sv_is_outlier, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  left_join(reason_breakdown, by = c("meta_triad_name", "meta_nbhd_code")) %>%
  mutate(
    outlier_pct_label = sprintf("%.1f%%", outlier_prop * 100),
    outlier_count_label = comma(outlier_count),
    total_sales_label = comma(total_sales)
  )


breaks <- c(0, 0.01, 0.015, 0.075, 0.10, 0.2, Inf)

palette_colors <- c(
  "#084B99", # blue
  "#1B8FC1", # blue-green
  "#00A65A", # green
  "#A4C238", # yellow-green
  "#D98B32", # orange
  "#CC0000" # red
)

format_pct <- function(x) {
  ifelse(x %% 1 == 0, sprintf("%d%%", as.integer(x)), sprintf("%.1f%%", x))
}

labels <- vapply(
  seq_len(length(breaks) - 1),
  function(i) {
    low <- breaks[i] * 100
    high <- breaks[i + 1] * 100
    if (is.infinite(high)) {
      paste0("≥ ", format_pct(low))
    } else {
      paste0(format_pct(low), " – ", format_pct(high))
    }
  },
  character(1)
)


make_triad_map <- function(triad_name) {
  triad_data <- nbhd_summary %>%
    filter(meta_triad_name == triad_name)

  map_data <- nbhd_sf %>%
    left_join(triad_data, by = c("town_nbhd" = "meta_nbhd_code")) %>%
    mutate(
      popup_html = ifelse(
        is.na(outlier_prop),
        paste0(
          "<strong>", htmlEscape(town_nbhd), " - ",
          htmlEscape(township_name), "</strong><br>",
          "<em>No training data for this neighborhood in this triad.</em>"
        ),
        paste0(
          "<strong>", htmlEscape(town_nbhd), " - ",
          htmlEscape(township_name), "</strong><br>",
          "<strong>Outlier proportion:</strong> ", outlier_pct_label,
          " (", outlier_count_label, " / ", total_sales_label, ")", "<br>",
          "<strong>Reason breakdown:</strong>",
          reason_html
        )
      )
    )

  pal <- colorBin(
    palette  = palette_colors,
    bins     = breaks,
    domain   = map_data$outlier_prop,
    na.color = "#bdbdbd",
    right    = FALSE
  )

  leaflet() %>%
    addMapPane("nbhd_pane", zIndex = 410) %>%
    addMapPane("township_pane", zIndex = 420) %>%
    addProviderTiles(providers$CartoDB.Positron) %>%
    addPolygons(
      data = map_data,
      fillColor = ~ pal(outlier_prop),
      color = "white",
      weight = 1,
      fillOpacity = 0.7,
      popup = ~popup_html,
      label = ~ lapply(popup_html, HTML),
      highlightOptions = highlightOptions(
        weight = 2,
        color = "black",
        bringToFront = TRUE
      ),
      options = pathOptions(pane = "nbhd_pane")
    ) %>%
    addPolygons(
      data = township_sf,
      fill = FALSE,
      color = "#202020",
      weight = 3,
      opacity = 0.9,
      smoothFactor = 0.5,
      options = pathOptions(pane = "township_pane", interactive = FALSE)
    ) %>%
    addLegend(
      position = "bottomright",
      colors   = palette_colors,
      labels   = labels,
      opacity  = 0.7,
      title    = glue("Outlier proportion ({triad_name})")
    )
}
```

::: {.panel-tabset}

### South

```{r}
make_triad_map("South")
```

### City

```{r}
make_triad_map("City")
```

### North

```{r}
make_triad_map("North")
```

:::

## Table Breakouts

::: panel-tabset

### By Outlier Type and Township

```{r _outliers_table_township_summary}
# This object is joined to itself using different filters, which is why this
# filtering is applied here rather than below.
outliers_table_township_summary <- training_data_outlier_analysis %>%
  filter(meta_class != "200" & meta_triad_name == run_triad)

outliers_table_township_summary <- outliers_table_township_summary %>%
  filter(sv_is_outlier) %>%
  summarise(
    `Min. Sale Price` = min(meta_sale_price, na.rm = TRUE),
    `Med. Sale Price` = median(meta_sale_price, na.rm = TRUE),
    `Max. Sale Price` = max(meta_sale_price, na.rm = TRUE),
    Count = n(),
    .by = c(sv_outlier_reason_simplified, meta_township_name)
  ) %>%
  left_join(
    outliers_table_township_summary %>%
      filter(!sv_is_outlier) %>%
      summarise(
        `Med. Non-Outlier Sale Price` = median(meta_sale_price, na.rm = TRUE),
        .by = c(meta_township_name)
      ),
    by = join_by(meta_township_name)
  ) %>%
  mutate(across(contains("Sale"), dollar)) %>%
  relocate(meta_township_name) %>%
  dplyr::rename(
    "Outlier Type" = sv_outlier_reason_simplified,
    "Township Name" = meta_township_name
  ) %>%
  arrange(`Township Name`, desc(Count))

outliers_table_township_summary %>%
  datatable(
    rownames = FALSE,
    filter = "top",
    options = list(
      columnDefs = list(
        list(className = "dt-center", targets = c(1)),
        list(className = "dt-right", targets = c(2:6))
      )
    )
  )
```

### By Outlier Type and Class

```{r _outliers_table_class_summary}
outliers_table_class_summary <- training_data_outlier_analysis %>%
  filter(meta_class != "200" & meta_triad_name == run_triad)

outliers_table_class_summary <- outliers_table_class_summary %>%
  filter(sv_is_outlier) %>%
  summarise(
    `Min. Sale Price` = min(meta_sale_price, na.rm = TRUE),
    `Med. Sale Price` = median(meta_sale_price, na.rm = TRUE),
    `Max. Sale Price` = max(meta_sale_price, na.rm = TRUE),
    Count = n(),
    .by = c(sv_outlier_reason_simplified, meta_class)
  ) %>%
  left_join(
    outliers_table_class_summary %>%
      filter(!sv_is_outlier) %>%
      summarise(
        `Med. Non-Outlier Sale Price` = median(meta_sale_price, na.rm = TRUE),
        .by = c(meta_class)
      ),
    by = join_by(meta_class)
  ) %>%
  mutate(across(contains("Sale"), dollar)) %>%
  relocate(meta_class) %>%
  dplyr::rename(
    "Outlier Type" = sv_outlier_reason_simplified,
    "Class" = meta_class
  ) %>%
  arrange(`Class`, desc(Count))

outliers_table_class_summary %>%
  datatable(
    rownames = FALSE,
    filter = "top",
    options = list(
      columnDefs = list(
        list(className = "dt-center", targets = c(1)),
        list(className = "dt-right", targets = c(2:6))
      )
    )
  )
```

:::

## Grouped by Decile

::: panel-tabset

### Share of Outliers by Decile

```{r _outliers_decile_share}
training_data_outlier_analysis %>%
  arrange(meta_sale_price) %>%
  mutate(decile = ntile(meta_sale_price, 10)) %>%
  summarise(
    percent = mean(case_when(sv_is_outlier == TRUE ~ 1, TRUE ~ 0)),
    lower_bound_short = shorten_number(min(meta_sale_price)),
    upper_bound_short = shorten_number(max(meta_sale_price)),
    .by = decile
  ) %>%
  mutate(
    custom_label = paste0(
      decile,
      "\n[", lower_bound_short, "-\n", upper_bound_short, "]"
    ),
    custom_label = forcats::fct_reorder(custom_label, decile)
  ) %>%
  ggplot(aes(x = custom_label, y = percent)) +
  geom_bar(stat = "identity") +
  geom_text(
    aes(label = scales::percent(percent, accuracy = 0.1)),
    vjust = 0,
    nudge_y = 0.005
  ) +
  theme_minimal() +
  scale_y_continuous(
    labels = scales::percent_format(),
    limits = c(0, NA),
    expand = expansion(add = c(0, 0.05))
  ) +
  scale_x_discrete(name = "Decile of Sale Price") +
  theme(
    axis.title.y = element_blank(),
    panel.grid.major.x = element_blank()
  )
```

### Outlier Types in Top Decile

```{r _outliers_decile_top}
outlier_decile_breakout <- function(data, dec) {
  outlier_decile_y_axis_lim <- data %>%
    arrange(meta_sale_price) %>%
    mutate(decile = ntile(meta_sale_price, 10)) %>%
    filter(decile == dec & sv_is_outlier == TRUE) %>%
    group_by(sv_outlier_reason_simplified) %>%
    summarise(count = n()) %>%
    ungroup() %>%
    slice_max(count, n = 1) %>%
    pull(count)

  data %>%
    arrange(meta_sale_price) %>%
    mutate(decile = ntile(meta_sale_price, 10)) %>%
    filter(decile == dec & sv_is_outlier) %>%
    summarise(count = n(), .by = sv_outlier_reason_simplified) %>%
    filter(count > 20) %>%
    ggplot(aes(x = reorder(sv_outlier_reason_simplified, count), y = count)) +
    labs(
      y = "Number of Sales",
      x = "Outlier Types"
    ) +
    geom_bar(stat = "identity") +
    geom_text(
      aes(label = comma(count)),
      hjust = 0,
      nudge_y = 20
    ) +
    scale_y_continuous(
      labels = comma,
      limits = c(0, 1.10 * outlier_decile_y_axis_lim)
    ) +
    theme_minimal() +
    theme(
      axis.text.y = element_text(hjust = 1),
      axis.title.y = element_blank(),
      axis.title.x = element_blank()
    ) +
    coord_flip()
}

outlier_decile_breakout(training_data_outlier_analysis, 10)
```

### Outlier Types in Bottom Decile

```{r _outliers_decile_bottom}
outlier_decile_breakout(training_data_outlier_analysis, 1)
```

:::
